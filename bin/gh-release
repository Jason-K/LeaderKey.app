#!/bin/bash
set -e

# Check if app bundle exists
if [[ ! -d "Updates/Leader Key.app" ]]; then
  echo "Error: Export app bundle to Updates/Leader Key.app first"
  exit 1
fi

# Get version from Xcode project
VERSION=$(xcodebuild -showBuildSettings -scheme "Leader Key" | grep MARKETING_VERSION | awk '{print $3}')
RELEASE_TAG="v$VERSION"
ZIP_FILE="Updates/Leader-Key-$VERSION.zip"

# Create zip
echo "Creating $ZIP_FILE"
ditto -c -k --sequesterRsrc --keepParent "Updates/Leader Key.app" "$ZIP_FILE"

# Create GitHub release draft
echo "Creating release draft $RELEASE_TAG"
gh release create "$RELEASE_TAG" "$ZIP_FILE" --draft --generate-notes

echo "âœ… Release draft created: $RELEASE_TAG"

# Auto-open release for editing
REPO=$(gh repo view --json owner,name -q '.owner.login + "/" + .name')
open "https://github.com/$REPO/releases/edit/$RELEASE_TAG"
